<html>
<body>

<h1>Poker (automatic opponent)</h1>

<button onclick='start()'>START</button>

<h4 id=alice_result></h4>
<div style="display: flex; padding-bottom: 10pt; display:none" id="alice_newbet">
    NEW BET:
    <button onclick='call(ALICE, "alice_newbet")'>Call</button>
    <button onclick='check(ALICE, "alice_newbet")'>Check</button>
    <button onclick='fold(ALICE, "alice_newbet")'>Fold</button>
    <button onclick='raise(ALICE, "alice_newbet", "alice_raise")'>Raise</button>
    <input id="alice_raise"></input>
</div>
<div style="display: flex; padding-bottom: 10pt">
    <button onclick='showPlayerCards(ALICE, "alice_player_cards")'>MY CARDS</button>
    <div id=alice_player_cards></div>
</div>
<div style="display: flex; padding-bottom: 10pt">
    <button onclick='showOpponentCards(ALICE, "alice_opponent_cards")'>OPPONENT CARDS</button>
    <div id=alice_opponent_cards></div>
</div>
<div style="display: flex; padding-bottom: 10pt">
    <button onclick='showCommunityCards(ALICE, "alice_community_cards")'>COMMUNITY CARDS</button>
    <div id=alice_community_cards></div>
</div>
<div style="display: flex; padding-bottom: 10pt">
    <button onclick='showBets(ALICE, "alice_bets")'>BETS</button>
    <div id=alice_bets></div>
</div>
<div style="display: flex; padding-bottom: 10pt">
    <button onclick='showFunds(ALICE, "alice_funds")'>FUNDS</button>
    <div id=alice_funds></div>
</div>
<div style="display: flex; padding-bottom: 10pt">
    <button onclick='showState(ALICE, "alice_state")'>STATE</button>
    <div id=alice_state></div>
</div>
<hr>
<div id=alice_div>
</div>


</body>
<script language="javascript" src="poker-api.js"></script>
<script language="javascript">
    let games = [];
    function start() {
        const alice_tx = new Transport();
        const bob_tx = new Transport();    
        const alice_funds = 100;
        const bob_funds = 100;
        const metadata = "";
        
        const alice = new Game(
            ALICE, alice_funds, bob_funds, metadata, alice_tx,
            () => onBetRequested(ALICE, "alice_newbet"),
            () => onEnd(ALICE, "alice_result"),
            msg => append_text('alice_div', msg)
        );
        const bob = new Game(
            BOB, alice_funds, bob_funds, metadata, bob_tx,
            () => onAutomaticBet(BOB)
        );
        
        alice_tx.connect(bob_tx);

        games = [];
        games.push(alice);
        games.push(bob);
        
        alice.start();
        bob.start();
    }

    function append_text(id, msg) {
        var el = document.getElementById(id);
        el.innerHTML += `${msg}<p/>`;
    }

    function showPlayerCards(player, id) {
        var cards = ["?", "?"];
        if (games[player]) {
            cards = games[player].getPlayerCards();
        }
        var div = document.getElementById(id);
        div.innerHTML = `${cards}`;
    }

    function showOpponentCards(player, id) {
        var cards = ["?", "?"];
        if (games[player]) {
            cards = games[player].getOpponentCards();
        }
        var div = document.getElementById(id);
        div.innerHTML = `${cards}`;
    }

    function showCommunityCards(player, id) {
        var cards = ["?", "?", "?", "?", "?"];
        if (games[player]) {
            cards = games[player].getCommunityCards();
        }
        var div = document.getElementById(id);
        div.innerHTML = `${cards}`;
    }

    function showFunds(player, id) {
        var funds = "?";
        if (games[player]) {
            funds = `${games[player].getPlayerFunds()} vs. ${games[player].getOpponentFunds()}`;
        }
        var div = document.getElementById(id);
        div.innerHTML = `${funds}`;
    }

    function showBets(player, id) {
        var bets = "?";
        if (games[player]) {
            bets = `${games[player].getPlayerBets()} vs. ${games[player].getOpponentBets()}`;
        }
        var div = document.getElementById(id);
        div.innerHTML = `${bets}`;
    }

    function showState(player, id) {
        var state = "?";
        if (games[player]) {
            state = games[player].getState();
        }
        var div = document.getElementById(id);
        div.innerHTML = `${state}`;
    }

    function onBetRequested(player, id) {
        if (games[player]) {
            var div = document.getElementById(id);
            div.style.display = "block";
        }
    }

    function onAutomaticBet(player) {
        setTimeout(() => {
            if (games[player]) {
                let choices = [0,1,2,3];
                while (true) {
                    let i = Math.floor(Math.random()*choices.length);
                    let choice = choices[i];
                    try {
                        if (choice == 0) {
                            games[player].call();
                        } else if (choice == 1) {
                            games[player].check();
                        } else if (choice == 2) {
                            games[player].fold();
                        } else if (choice == 3) {
                            let amount = Math.floor(Math.random()*5);
                            games[player].raise(amount);
                        }
                        break;
                    } catch (e) {
                        // bet choice not allowed, remove that possibility and try again
                        choices.splice(i, 1);
                    }
                }
            }
        }, 0);
    }

    function onEnd(player, id) {
        if (games[player]) {
            let result = games[player].getResult();
            document.getElementById(id).innerHTML = `RESULT: ${JSON.stringify(result)}`;
        }
    }

    function call(player, id) {
        if (games[player]) {
            games[player].call();
            document.getElementById(id).style.display = "none";
        }
    }
    function check(player, id) {
        if (games[player]) {
            games[player].check();
            document.getElementById(id).style.display = "none";
        }
    }
    function fold(player, id) {
        if (games[player]) {
            games[player].fold();
            document.getElementById(id).style.display = "none";
        }
    }
    function raise(player, id, idInput) {
        if (games[player]) {
            var input = document.getElementById(idInput);
            games[player].raise(input.value);
            document.getElementById(id).style.display = "none";
        }
    }

</script>

</html>